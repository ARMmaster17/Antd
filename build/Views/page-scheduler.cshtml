@*
///-------------------------------------------------------------------------------------
///     Copyright (c) 2014, Anthilla S.r.l. (http://www.anthilla.com)
///     All rights reserved.
///
///     Redistribution and use in source and binary forms, with or without
///     modification, are permitted provided that the following conditions are met:
///         * Redistributions of source code must retain the above copyright
///           notice, this list of conditions and the following disclaimer.
///         * Redistributions in binary form must reproduce the above copyright
///           notice, this list of conditions and the following disclaimer in the
///           documentation and/or other materials provided with the distribution.
///         * Neither the name of the Anthilla S.r.l. nor the
///           names of its contributors may be used to endorse or promote products
///           derived from this software without specific prior written permission.
///
///     THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
///     ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
///     WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
///     DISCLAIMED. IN NO EVENT SHALL ANTHILLA S.R.L. BE LIABLE FOR ANY
///     DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
///     (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
///     LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
///     ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
///     (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
///     SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
///
///     20141110
///-------------------------------------------------------------------------------------*@

@inherits Nancy.ViewEngines.Razor.NancyRazorViewBase<dynamic>
@{Layout = "_layout.cshtml";}

@section PageBar {
    <style type="text/css">
        #Scheduler-TB {
            border-bottom: 10px solid #A7BD39;
            height: 80px !important;
        }
    </style>
    <nav class="navigation-bar bg-anthilla-gray-m page-bar menu-bar" style="height: 50px !important;">
        <nav class="navigation-bar-content">
            <div class="element upcase fg-anthilla-green border-2-anthilla-gray-m no-overlay" style="padding-top: 11px;">
                <i class="icon-box on-left" style="line-height: 5px;"></i>
                Scheduler
            </div>
            <div class="element-divider"></div>

            <a class="element upcase fg-anthilla-green border-2-anthilla-green no-overlay anchor" data-scrollto="#OneTimeOnly" style="padding-top: 11px;">New One time only
            </a>
            <div class="element-divider"></div>
            <a class="element upcase fg-anthilla-green border-2-anthilla-green no-overlay anchor" data-scrollto="#Cron" style="padding-top: 11px;">New with Cron
            </a>
            <div class="element-divider"></div>
        </nav>
    </nav>
}

@section Dashboard {
    @functions{
        public string[] DaysOfTheWeek = new string[] {
            "Monday",
	        "Tuesday",
	        "Wednesday",
	        "Thursday",
	        "Friday",
	        "Saturday",
	        "Sunday"
        };

        public string[] MonthsOfTheYear = new string[] {
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
        };

        public string GetMonthNumber(string month) {
            int index = Array.IndexOf(MonthsOfTheYear, month);
            return (index + 1).ToString();
        }
    }
    <form id="OneTimeOnly" action="/scheduler/now" method="POST" enctype="multipart/form-data" style="display: none;">
        <div class="grid">
            <div class="row">
                <div class="span2">
                    <label>Name</label>
                </div>
                <div class="span10">
                    <input type="text" name="Alias" style="width: 90%; height: 25px;">
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>Command</label>
                </div>
                <div class="span10">
                    <input type="text" name="Command" style="width: 90%; height: 25px;">
                </div>
            </div>
            <div class="row">
                <div class="span12">
                    <label>&nbsp</label>
                    <input class="bg-anthilla-green fg-white" type="submit" value="Submit" style="width: 100%; height: 34px;">
                </div>
            </div>
        </div>
    </form>
    <form id="Cron" action="/scheduler/cron" method="POST" enctype="multipart/form-data" style="display: none;">
        <div class="grid" style="padding-left: 25px;">
            <div class="row">
                <div class="span2">
                    <label>Name</label>
                </div>
                <div class="span10">
                    <input type="text" name="Alias" style="width: 90%; height: 25px;">
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>Command</label>
                </div>
                <div class="span10">
                    <input type="text" name="Command" style="width: 90%; height: 25px;">
                    <input type="text" name="Command" style="width: 90%;">
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>Start Time</label>
                </div>
                <div class="span10">
                    <select id="CronStartTimeHour" name="CronStartTimeHour" class="bg-anthilla-gray border-anthilla-green fg-white" style="width: 75px; text-align: right; padding-right: 10px;">
                        @for (int i = 0; i < 24; i++) {
                            <option value="@i.ToString()" >@i.ToString() </option>
                        }
                    </select>
                    <select id="CronStartTimeMinute" name="CronStartTimeMinute" class="bg-anthilla-gray border-anthilla-green fg-white" style="width: 75px; text-align: right; padding-right: 10px;">
                        @for (int i = 0; i < 60; i++) {
                            <option value="@i.ToString()" >@i.ToString() </option>
                        }
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>Minutes</label>
                </div>
                <div class="span10">
                    <p style="display: inline-block;">Every</p>
                    <input id="CronMinutes" type="text" />
                    <p style="display: inline-block;">minute(s)</p>
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>Hours</label>
                </div>
                <div class="span10">
                    <p style="display: inline-block;">Every</p>
                    <input id="CronHours" type="text" />
                    <p style="display: inline-block;">hour(s)</p>
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>Select Days</label>
                </div>
                <div class="span10">
                    <input name="CronDays" id="CronDaysPeriodic" type="radio" checked />
                    -
                <p style="display: inline-block;">Every</p>
                    <input id="CronDays" type="text" value="1" />
                    <p style="display: inline-block;">day(s)</p>
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>&nbsp</label>
                </div>
                <div class="span10" id="CronDotW">
                    <input name="CronDays" id="CronDaysDaysOfWeek" type="radio" />
                    -
                @foreach (string day in DaysOfTheWeek) {
                    <input class="cronDayOfTheWeek" type="checkbox" checked="checked" value="@day.Substring(0, 3).ToUpper()" />
                    <p style="display: inline-block;">@day</p>
                }
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>Select Month</label>
                </div>
                <div class="span11" id="CronMotY">
                    @foreach (string month in MonthsOfTheYear) {
                        <input class="cronMonthOfTheYear" type="checkbox" checked="checked" value="@GetMonthNumber(month)" />
                        <p style="display: inline-block;">@month</p>
                    }
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    <label>End Time</label>
                </div>
                <div class="span10">
                    <select id="CronEndTimeHour" name="CronEndTimeHour" class="bg-anthilla-gray border-anthilla-green fg-white" style="width: 75px; text-align: right; padding-right: 10px;">
                        @for (int i = 0; i < 24; i++) {
                            <option value="@i.ToString()" >@i.ToString() </option>
                        }
                    </select>
                    <select id="CronEndTimeMinute" name="CronEndTimeMinute" class="bg-anthilla-gray border-anthilla-green fg-white" style="width: 75px; text-align: right; padding-right: 10px;">
                        @for (int i = 0; i < 60; i++) {
                            <option value="@i.ToString()" >@i.ToString() </option>
                        }
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="span2">
                    @*<input id="ShowCronResult" class="bg-yellow fg-white" type="button" value="Cron Result" style="width: 90%; height: 34px;" />*@
                </div>
                <div class="span10">
                    <input name="CronResult" id="CronResult" type="text" style="width: 90%; height: 35px; border-width: 0 0 2px 0 !important; border-color: #A7BD39 !important;" class="bg-anthilla-gray-m" />
                </div>
            </div>
            <div class="row">
                <div class="span12">
                    <label>&nbsp</label>
                    <input id="submit" class="bg-anthilla-green fg-white" type="submit" value="Submit" style="width: 100%; height: 34px;">
                </div>
            </div>
        </div>
    </form>
}

@section MainContent {
    @functions{
        public string SetCommandLine(string json) {
            string[] data = Newtonsoft.Json.JsonConvert.DeserializeObject<string[]>(json);
            string d = String.Join(" ", data);
            return d;
        }
    }

    @foreach (Antd.Scheduler.JobModel job in Model.JobList) {
        @if (job != null) {
            <div data-role="panel" class="panel collapsed border-2-anthilla-gray" data-guid="@job.Guid" style="margin-bottom: 5px;">
                <div class="panel-header bg-anthilla-gray fg-white">
                    <p class="fg-white" style="display: inline-block;"><i class="icon-arrow-right-5 on-left"></i>@job.Alias</p>
                    <p class="fg-white" style="display: inline-block;">@SetCommandLine(job.Data)</p>
                </div>
                <div class="panel-content" style="display: none;">
                    <ul class="fg-white" style="list-style: none;">
                        <li>
                            <label>Name</label>
                            <p>@job.Alias</p>
                        </li>
                        <li>
                            <label>Command launched at this scheduled task</label>
                            <p>@SetCommandLine(job.Data)</p>
                        </li>
                        <li>
                            <label>Interval</label>
                            <p>@job.Interval</p>
                        </li>
                        <li>
                            <label>Start Time</label>
                            <p>@job.Trigger.StartTime.ToString("HH:mm")</p>
                        </li>
                        <li>
                            <label>Cron</label>
                            <p>@job.Trigger.CronExpression</p>
                        </li>
                    </ul>
                    <hr />
                    @if (job.isEnabled == true) {
                        <p class="button bg-yellow" data-action="disable" style="color: black !important;">Status: Enabled</p>
                    }
                    @if (job.isEnabled == false) {
                        <p class="button bg-yellow" data-action="enable" style="color: black !important;">Status: Disabled</p>
                    }
                    <p class="button bg-yellow" data-action="launch" style="color: black !important;">Launch Now</p>
                    <p class="button bg-yellow" data-action="delete" style="color: black !important;">Delete</p>
                </div>
            </div>
        }
    }

}

@section Scripts {
    <script type="text/javascript">

        $('a[data-scrollto="#OneTimeOnly"]').click(function () {
            $('#Cron').hide();
            $('#OneTimeOnly').toggle();
        });

        $('a[data-scrollto="#Cron"]').click(function () {
            $('#OneTimeOnly').hide();
            $('#Cron').toggle();
        });

        $('input[type="text"], input[type="checkbox"], input[type="radio"], select, option').click(function () {
            var $defaults = {
                zero: '0',
                all: '*',
                what: '?'
            };
            var cronExpression;
            var seconds = $defaults.zero,
                minutes = $defaults.zero,
                hours = $defaults.zero,
                dayOfmonth = $defaults.all,
                month = $defaults.all,
                dayOfweek = $defaults.all;
            var $formatExample = '0 0/5 * * *'

            //controlla se c'è una periodicità nei minuti
            var periodMinutes = $('#CronMinutes').val();
            if (periodMinutes == '') {
                minutes = $('#CronStartTimeMinute').val();
            }
            else {
                minutes = '0/' + periodMinutes;
            }

            //controlla se c'è una periodicità nelle ore
            var periodHours = $('#CronHours').val();
            if (periodHours == '') {
                hours = $('#CronStartTimeHour').val();
            }
            else {
                hours = '0/' + periodHours;
            }

            //prima check il tipo di periodicità nei giorni
            if ($('#CronDaysPeriodic').prop('checked')) {
                dayOfweek = $defaults.what;
                //controlla se c'è una periodicità nei giorni
                var periodDays = $('#CronDays').val();
                if (periodDays == '') {
                    dayOfmonth = $defaults.what;
                }
                else {
                    dayOfmonth = '1/' + periodDays;
                }
            }
            if ($('#CronDaysDaysOfWeek').prop('checked')) {
                dayOfmonth = $defaults.what;
                var dayz = [];
                $('#CronDotW').find('.cronDayOfTheWeek:checked').each(function (index) {
                    dayz.push($(this).val());
                });
                dayOfweek = dayz.join(',');
            }

            var monthz = [];
            $('#CronMotY').find('.cronMonthOfTheYear:checked').each(function (index) {
                monthz.push($(this).val());
            });
            if (monthz.length == 0 || monthz.length == 12) {
                month = $defaults.all;
            }
            else {
                month = monthz.join(',');
            }

            cronExpression = seconds + ' ' + minutes + ' ' + hours + ' ' + dayOfmonth + ' ' + month + ' ' + dayOfweek;
            $('#CronResult').val(cronExpression);
        });
    </script>
}